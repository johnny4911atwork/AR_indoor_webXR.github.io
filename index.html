<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR 訊號點標記</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        #startButton, #placeMarkerButton {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            font-size: 18px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        #placeMarkerButton {
            display: none;
            background: #2196F3;
        }
        #info {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 1000;
            text-align: center;
        }
        #markerCount {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(33, 150, 243, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="info">請點擊開始按鈕啟動 AR</div>
        <div id="markerCount" style="display:none;">訊號點數量: 0</div>
        <button id="startButton">開始 AR</button>
        <button id="placeMarkerButton">放置訊號點</button>
    </div>

    <script type="module">
        import * as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.js';

        let camera, scene, renderer, gl;
        let session = null;
        let refSpace = null;
        let markers = [];
        let markerCount = 0;

        const startButton = document.getElementById('startButton');
        const placeMarkerButton = document.getElementById('placeMarkerButton');
        const info = document.getElementById('info');
        const markerCountDiv = document.getElementById('markerCount');

        // 初始化場景
        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
            
            // 添加環境光
            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
            light.position.set(0.5, 1, 0.25);
            scene.add(light);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            
            document.getElementById('container').appendChild(renderer.domElement);
        }

        // 創建訊號點標記
        function createMarker(number) {
            const group = new THREE.Group();

            // 底座圓盤
            const baseGeometry = new THREE.CylinderGeometry(0.15, 0.15, 0.02, 32);
            const baseMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x2196F3,
                emissive: 0x2196F3,
                emissiveIntensity: 0.3
            });
            const base = new THREE.Mesh(baseGeometry, baseMaterial);
            group.add(base);

            // 中心圓柱
            const poleGeometry = new THREE.CylinderGeometry(0.02, 0.02, 0.3, 16);
            const poleMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xFFEB3B,
                emissive: 0xFFEB3B,
                emissiveIntensity: 0.5
            });
            const pole = new THREE.Mesh(poleGeometry, poleMaterial);
            pole.position.y = 0.15;
            group.add(pole);

            // 頂部球體
            const sphereGeometry = new THREE.SphereGeometry(0.05, 16, 16);
            const sphereMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xFF5722,
                emissive: 0xFF5722,
                emissiveIntensity: 0.6
            });
            const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
            sphere.position.y = 0.32;
            group.add(sphere);

            // 編號文字平面
            const canvas = document.createElement('canvas');
            canvas.width = 128;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'Bold 80px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(number.toString(), 64, 64);

            const texture = new THREE.CanvasTexture(canvas);
            const textMaterial = new THREE.MeshBasicMaterial({ 
                map: texture, 
                transparent: true,
                side: THREE.DoubleSide
            });
            const textGeometry = new THREE.PlaneGeometry(0.15, 0.15);
            const textMesh = new THREE.Mesh(textGeometry, textMaterial);
            textMesh.position.y = 0.15;
            textMesh.rotation.x = -Math.PI / 2;
            textMesh.position.z = 0.001; // 稍微提高避免 z-fighting
            group.add(textMesh);

            return group;
        }

        // 放置訊號點
        function placeMarker() {
            if (!session || !refSpace) return;

            const viewer = session.requestReferenceSpace('viewer');
            viewer.then(viewerSpace => {
                const pose = session.frame.getViewerPose(refSpace);
                if (pose) {
                    const view = pose.views[0];
                    const transform = view.transform;
                    
                    markerCount++;
                    const marker = createMarker(markerCount);
                    
                    // 在用戶當前位置的地面放置
                    marker.position.set(
                        transform.position.x,
                        transform.position.y - 1.3, // 降低到地面高度
                        transform.position.z
                    );
                    
                    scene.add(marker);
                    markers.push(marker);
                    
                    updateMarkerCount();
                    info.textContent = `已放置訊號點 #${markerCount}`;
                }
            });
        }

        function updateMarkerCount() {
            markerCountDiv.textContent = `訊號點數量: ${markerCount}`;
        }

        // 開始 AR 會話
        async function startAR() {
            if (!navigator.xr) {
                info.textContent = '您的裝置不支援 WebXR';
                return;
            }

            try {
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                if (!supported) {
                    info.textContent = '您的裝置不支援 AR 模式';
                    return;
                }

                session = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['viewer']
                });

                await renderer.xr.setSession(session);
                refSpace = await session.requestReferenceSpace('viewer');

                session.addEventListener('end', () => {
                    session = null;
                    refSpace = null;
                    startButton.style.display = 'block';
                    placeMarkerButton.style.display = 'none';
                    markerCountDiv.style.display = 'none';
                    info.textContent = 'AR 已結束';
                });

                startButton.style.display = 'none';
                placeMarkerButton.style.display = 'block';
                markerCountDiv.style.display = 'block';
                info.textContent = '移動到想要的位置後,點擊「放置訊號點」';

                renderer.setAnimationLoop(render);
            } catch (err) {
                info.textContent = 'AR 啟動失敗: ' + err.message;
            }
        }

        function render(timestamp, frame) {
            if (frame) {
                renderer.render(scene, camera);
            }
        }

        // 事件監聽
        startButton.addEventListener('click', startAR);
        placeMarkerButton.addEventListener('click', placeMarker);

        // 初始化
        init();
    </script>
</body>
</html>
